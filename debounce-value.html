<link rel="import" href="../polymer/polymer.html">

<script>
	(function () {
		class DebounceValue extends Polymer.Element {
			static get is() {
				return 'debounce-value';
			}

			static get properties() {
				return {
					source: {
						type: Object,
						observer: '_sourceChange',
						notify: true
					},
					destination: {
						type: Object,
						observer: '_destinationChange',
						notify: true
					},
					wait: {
						type: Number,
						value: 0
					}
				}
			}

			_assignSource() {
				// Avoid assigning the same value which would result in a replicant loop.
				if (this.source !== this.destination) {
					this.source = this.destination;
				}
				this._debounceAssignSource = undefined;
			}

			_assignDestination() {
				// Only assign the incoming value if there's not an active local set waiting.
				if (this._debounceAssignSource == undefined) {
					this.destination = this.source;
				}
				this._debounceAssignDestination = undefined;
			}

			_sourceChange() {
				if (!this._settled) {
					this._assignDestination();
					this._settled = true;
					return;
				}

				this._debounceAssignDestination = Polymer.Debouncer.debounce(this._debounceAssignDestination,
					Polymer.Async.timeOut.after(this.wait),
					() => {
						this._assignDestination()
					});
			}

			_destinationChange() {
				if (!this._settled) {
					return;
				}

				this._debounceAssignSource = Polymer.Debouncer.debounce(this._debounceAssignSource,
					Polymer.Async.timeOut.after(this.wait),
					() => {
						this._assignSource();
					});
			}
		}

		customElements.define(DebounceValue.is, DebounceValue);
	})()
</script>
